
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Reciclaje - Kotlin/JS</title>
    <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para mejor legibilidad */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Estilos específicos para la estética del reciclaje */
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'recycle-green': '#10b981', /* Esmeralda de Tailwind */
                        'recycle-dark': '#047857',
                        'recycle-light': '#d1fae5',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-recycle-dark mb-2 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-recycle-green" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11 2a1 1 0 011 1v2h3a1 1 0 011 1v9a2 2 0 01-2 2H6a2 2 0 01-2-2V6a1 1 0 011-1h3V3a1 1 0 011-1zM5 7h10v8H5V7zm5-4h2V5h-2V3z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M10 11a1 1 0 001-1V6a1 1 0 00-2 0v4a1 1 0 001 1z" clip-rule="evenodd" />
                </svg>
                Sistema de Reciclaje
            </h1>
            <p class="text-gray-600">Registro de materiales y cálculo de beneficios con lógica Kotlin.</p>
        </header>

        <!-- Sección de Entrada de Datos -->
        <div class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Registrar Material</h2>
            
            <div id="message-box" class="hidden p-3 rounded-lg mb-4 text-sm font-medium"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="material-name" class="block text-sm font-medium text-gray-700">Material (Ej: Botella PET)</label>
                    <input type="text" id="material-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-recycle-green focus:ring focus:ring-recycle-green focus:ring-opacity-50 p-2 border" placeholder="Nombre del material">
                </div>
                <div>
                    <label for="material-weight" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                    <input type="number" step="0.01" id="material-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-recycle-green focus:ring focus:ring-recycle-green focus:ring-opacity-50 p-2 border" placeholder="0.00">
                </div>
                <div class="flex items-end">
                    <button id="add-item-btn" class="w-full bg-recycle-green hover:bg-recycle-dark text-white font-bold py-2 px-4 rounded-lg transition duration-150 transform hover:scale-[1.02]">
                        Agregar Item
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección de Resumen y Resultados -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Items Registrados -->
            <div class="lg:col-span-2 card bg-white p-6 rounded-xl">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Items Registrados</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-recycle-light">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Peso (kg)</th>
                                <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Beneficio ($)</th>
                                <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Los items se renderizarán aquí -->
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">No hay ítems registrados.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Resumen Total -->
            <div class="lg:col-span-1 card bg-recycle-dark text-white p-6 rounded-xl flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-semibold mb-4">Resumen de la Tarea</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                            <span class="text-lg">Total Items:</span>
                            <span id="total-items" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                            <span class="text-lg">Peso Total (kg):</span>
                            <span id="total-weight" class="text-2xl font-bold">0.00</span>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-600">
                    <p class="text-lg font-medium">Beneficio Total Estimado:</p>
                    <p id="final-benefit" class="text-5xl font-extrabold text-yellow-300">$0.00</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Script de la Interfaz de Usuario (UI) -->
    <script>
        
        let servicioReciclaje; // Instancia del ServicioReciclaje de Kotlin
        let TareaDeReciclajeActual; // Instancia de la TareaDeReciclaje de Kotlin
        
        // Nombres de clases y objetos que tu código Kotlin debe exponer
        // (Asegúrate de que tus clases Kotlin sean 'open' o usa la anotación '@JsExport'
        // para exponerlas al JavaScript si usas la convención de paquetes de Kotlin/JS)

        window.onload = function() {
            try {
                // ASUMIMOS que tu código Kotlin expone una clase llamada 'ServicioReciclaje', 'CatalogoMateriales', etc.
                const catalogo = new CatalogoMateriales();
                const calculadora = new CalculadoraBeneficios();
                const validador = new ValidadorEntrada();
                servicioReciclaje = new ServicioReciclaje(catalogo, calculadora, validador);
                
                TareaDeReciclajeActual = servicioReciclaje.iniciarNuevaTarea();

                const addItemBtn = document.getElementById('add-item-btn');
                addItemBtn.addEventListener('click', handleAddItem);
                
                // Adjuntar evento de eliminación a la tabla
                document.getElementById('items-table-body').addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) {
                        // El ID debe ser el mismo tipo que usa tu lógica Kotlin (aquí asumimos Double para simplificar la conexión)
                        const itemId = parseFloat(e.target.dataset.itemId); 
                        handleDeleteItem(itemId);
                    }
                });
                
                renderItems();

            } catch (error) {
                // Esto se mostrará si el código Kotlin aún no está cargado o si los nombres de las clases son incorrectos.
                displayMessage("ERROR: No se pudo iniciar el servicio Kotlin. Asegúrate de haber compilado el código y de que la clase 'ServicioReciclaje' y sus dependencias estén expuestas correctamente usando @JsExport.", 'error');
                console.error("Error al iniciar el servicio Kotlin:", error);
            }
        };
        
        /**
         * Muestra mensajes de estado (éxito o error).
         */
        function displayMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `p-3 rounded-lg mb-4 text-sm font-medium ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 5000); // Ocultar después de 5 segundos
        }

        /**
         * Maneja el evento de click para agregar un item.
         */
        function handleAddItem() {
            const nameInput = document.getElementById('material-name');
            const weightInput = document.getElementById('material-weight');
            
            const nombre = nameInput.value;
            const peso = weightInput.value;

            // Llama al servicio Kotlin
            const resultado = servicioReciclaje.agregarItemATarea(
                TareaDeReciclajeActual, nombre, peso
            );

            // La UI debe inspeccionar el tipo de resultado (basado en la sealed class de Kotlin)
            
            if (resultado.constructor && resultado.constructor.name.includes('Exito')) {
                // Aquí asumimos que el objeto expuesto tiene un campo 'item.material.nombre' y 'beneficio'
                const materialNombre = resultado.item.material.nombre;
                const beneficio = resultado.beneficio;

                displayMessage(`¡Éxito! Agregado ${materialNombre} (${peso} kg). Beneficio: $${beneficio.toFixed(2)}`, 'success');
                nameInput.value = '';
                weightInput.value = '';
                renderItems();

            } else if (resultado.constructor && resultado.constructor.name.includes('Error')) {
                displayMessage(`Error de Validación: ${resultado.mensaje}`, 'error');

            } else if (resultado.constructor && resultado.constructor.name.includes('MaterialNoEncontrado')) {
                // Aquí asumimos que el objeto expuesto tiene un campo 'nombreBuscado' y 'materialesDisponibles'
                // Nota: Los materiales disponibles podrían ser un arreglo de objetos MaterialReciclable en JS
                displayMessage(`Error: Material "${resultado.nombreBuscado}" no encontrado.`, 'error');
                
            } else {
                displayMessage("Ocurrió un error desconocido. Verifica la consola y la estructura de la clase sellada.", 'error');
                console.error("Resultado inesperado del servicio Kotlin:", resultado);
            }
        }
        
        /**
         * Elimina un item de la tarea.
         */
        function handleDeleteItem(itemId) {
            // Llama a la función de eliminación del servicio Kotlin
            if (servicioReciclaje.eliminarItem(TareaDeReciclajeActual, itemId)) {
                displayMessage("Item eliminado correctamente.", 'success');
                renderItems();
            } else {
                displayMessage("Error al intentar eliminar el item.", 'error');
            }
        }

        /**
         * Renderiza la tabla de items y actualiza el resumen total.
         */
        function renderItems() {
            const tableBody = document.getElementById('items-table-body');
            tableBody.innerHTML = '';
            
            let totalWeight = 0;
            let totalBenefit = 0;

            // Llama al método de Kotlin para obtener la lista de items
            const items = TareaDeReciclajeActual.obtenerItems();

            if (items.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay ítems registrados.</td></tr>';
            } else {
                items.forEach(item => {
                    // El cálculo del beneficio debe ser el valor devuelto por la lógica Kotlin si no se recalculó en JS
                    // Asumimos que ItemReciclado tiene un ID que es el mismo que usamos para eliminar (String o Double)
                    const itemId = item.id; // Asumiendo que el ID se expone
                    
                    // Asumiendo que el item expone el material y el peso
                    const beneficioItem = item.pesoEnKg * item.material.precioPorUnidad; 

                    totalWeight += item.pesoEnKg;
                    totalBenefit += beneficioItem;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap">${item.material.nombre || 'Desconocido'}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${item.material.categoria.name}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-right">${item.pesoEnKg.toFixed(2)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-right text-recycle-dark font-semibold">$${beneficioItem.toFixed(2)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-right">
                            <button data-item-id="${itemId}" class="delete-btn text-red-600 hover:text-red-900 font-medium text-sm">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }


            // Actualizar el resumen
            document.getElementById('total-items').textContent = items.length;
            document.getElementById('total-weight').textContent = totalWeight.toFixed(2);
            // Llama a la función final de Kotlin
            const finalBenefit = servicioReciclaje.finalizarTarea(TareaDeReciclajeActual);
            document.getElementById('final-benefit').textContent = `$${finalBenefit.toFixed(2)}`;
        }
    </script>
    
    <!-- 
        *** PASO FINAL PARA KOTLIN/JS (SOLO KOTLIN) ***
        
        1. Compila tu proyecto Kotlin a JavaScript (esto debe generar un archivo .js).
        2. Enlaza ese archivo .js aquí para que la interfaz pueda usar tus clases Kotlin. 
    -->
   <script src="interfazweb.html"></script>
</body>
</html>
